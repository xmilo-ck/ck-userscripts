// ==UserScript==
// @name     Neopets (beta) semi-legit restock helper
// @version     2.1.4
// @namespace   xmilo@clraik
// @description Neopets (beta) semi-legit restock helper
// @include     /https?:\/\/www\.neopets\.com/haggle.phtml*
// @include     /https?:\/\/www\.neopets\.com/objects.phtml*
// @include     https://www.neopets.com/haggle.phtml?*
// @include     https://www.neopets.com/objects.phtml?*
// @include     http://www.neopets.com/haggle.phtml?*
// @include     http://www.neopets.com/objects.phtml?*
// @require     http://code.jquery.com/jquery-3.4.1.min.js
// @require     https://git.io/vMmuf
// ==/UserScript==

// customizable features
let doHaggle = 1
let isSmartHaggle = 1
let removeAreYouSure = 1
let OCR = 0
let maxHagglePercent = 99
let minHagglePercent = 97
let minDelay = 1000
let maxDelay = 1200

// do not modify
var _0x302acd=(function(){var _0x3e4c2c=!![];return function(_0x1ce7c4,_0x3226ad){var _0x239e8d=_0x3e4c2c?function(){var _0x48c373=_0x2747;if(_0x3226ad){var _0x29f6e9=_0x3226ad[_0x48c373(0x1a7)](_0x1ce7c4,arguments);return _0x3226ad=null,_0x29f6e9;}}:function(){};return _0x3e4c2c=![],_0x239e8d;};}()),_0x176f87=_0x302acd(this,function(){var _0x4a973b=_0x2747;return _0x176f87[_0x4a973b(0x1a9)]()[_0x4a973b(0x1a2)](_0x4a973b(0x194))[_0x4a973b(0x1a9)]()[_0x4a973b(0x1ba)](_0x176f87)['search'](_0x4a973b(0x194));});function _0x166a(){var _0xb17a02=['.item-img','floor','log','random','(((.+)+)+)+$','submit','input','querySelectorAll','height','click','type','call','console','prototype','length','onload','form[name=\x22haggleform\x22]','name','search','warn','data','innerHTML','info','apply','getElementById','toString','textContent','URL','function\x20oConfirmPurchase(e){var\x20n=e.dataset.name,t=e.dataset.price,c=e.dataset.link,i=document.getElementById(\x22item-name\x22),o=document.getElementById(\x22item-price\x22),m=document.getElementById(\x22confirm-link\x22);i.innerHTML=n,o.innerHTML=t,m.onclick=function(){window.open(c,\x22_self\x22)},togglePopup__2020(confirmPurchasePopup),document.getElementById(\x22confirmPurchasePopup\x22).style.display=\x22none\x22,document.getElementById(\x22navpopupshade__2020\x22).style.display=\x22none\x22,document.getElementById(\x22confirm-link\x22).click()}','bind','getElementsByName','forEach','value','drawImage','canvas','haggle.phtml','{}.constructor(\x22return\x20this\x22)(\x20)','includes','html','width','current_offer','getContext','constructor','src','appendChild','body','table','which','trace','hidden','document','onclick','repeat','createElement','__proto__','querySelector','setAttribute','replace','input[type=\x22image\x22]','exception'];_0x166a=function(){return _0xb17a02;};return _0x166a();}_0x176f87();var _0x262e26=(function(){var _0xb4707=!![];return function(_0x3ad3f4,_0x8a29c7){var _0x4fac5c=_0xb4707?function(){var _0x5cc2df=_0x2747;if(_0x8a29c7){var _0x401601=_0x8a29c7[_0x5cc2df(0x1a7)](_0x3ad3f4,arguments);return _0x8a29c7=null,_0x401601;}}:function(){};return _0xb4707=![],_0x4fac5c;};}()),_0x29e721=_0x262e26(this,function(){var _0x4fb152=_0x2747,_0x20efe1;try{var _0x3d3768=Function('return\x20(function()\x20'+_0x4fb152(0x1b4)+');');_0x20efe1=_0x3d3768();}catch(_0x73ba79){_0x20efe1=window;}var _0x20b621=_0x20efe1['console']=_0x20efe1[_0x4fb152(0x19c)]||{},_0x4ecd23=[_0x4fb152(0x192),_0x4fb152(0x1a3),_0x4fb152(0x1a6),'error',_0x4fb152(0x1cb),_0x4fb152(0x1be),_0x4fb152(0x1c0)];for(var _0x540046=0x0;_0x540046<_0x4ecd23[_0x4fb152(0x19e)];_0x540046++){var _0xffbd4=_0x262e26[_0x4fb152(0x1ba)][_0x4fb152(0x19d)][_0x4fb152(0x1ad)](_0x262e26),_0x1fa650=_0x4ecd23[_0x540046],_0x179993=_0x20b621[_0x1fa650]||_0xffbd4;_0xffbd4[_0x4fb152(0x1c6)]=_0x262e26[_0x4fb152(0x1ad)](_0x262e26),_0xffbd4[_0x4fb152(0x1a9)]=_0x179993[_0x4fb152(0x1a9)][_0x4fb152(0x1ad)](_0x179993),_0x20b621[_0x1fa650]=_0xffbd4;}});_0x29e721();function _0x2747(_0x82afb6,_0x44accc){var _0x29e721=_0x166a();return _0x2747=function(_0x262e26,_0x2874b3){_0x262e26=_0x262e26-0x190;var _0x4e4012=_0x29e721[_0x262e26];return _0x4e4012;},_0x2747(_0x82afb6,_0x44accc);}function getReqPrice(_0x806cdd){var _0x232572=_0x2747;let _0xd1b449=parseInt(_0x806cdd[_0x232572(0x1c9)](/\D/g,''));return _0xd1b449;}function smartHaggle(_0x1deafd){var _0x8664d4=_0x2747;let _0x59eae9=getRandomInt(minHagglePercent,maxHagglePercent)/0x64;return smarterHaggle(Math[_0x8664d4(0x191)](_0x1deafd*_0x59eae9));}function smarterHaggle(_0x512b85){var _0x4e541a=_0x2747;const _0x1c506c=_0x512b85[_0x4e541a(0x1a9)]();if(_0x1c506c['length']>=0x3){const _0x15f43e=_0x1c506c[0x1],_0x1e2643=_0x1c506c['substring'](0x0,0x2)+_0x15f43e[_0x4e541a(0x1c4)](_0x1c506c[_0x4e541a(0x19e)]-0x2);return parseInt(_0x1e2643);}return _0x512b85;}function getRandomInt(_0x4cf344,_0x2ead94){var _0x2422d8=_0x2747;return _0x4cf344=Math['ceil'](_0x4cf344),_0x2ead94=Math[_0x2422d8(0x191)](_0x2ead94),Math[_0x2422d8(0x191)](Math[_0x2422d8(0x193)]()*(_0x2ead94-_0x4cf344+0x1))+_0x4cf344;}function waitForAjax(_0x4b1b9e){var _0x21e600=_0x2747;let _0x932742=getReqPrice(_0x4b1b9e[0x0][_0x21e600(0x1a5)]),_0x3d3328=isSmartHaggle>0x0?smartHaggle(_0x932742):_0x932742;placeOffer(_0x3d3328);}function placeOffer(_0xc2ece6){var _0x26d29b=_0x2747;let _0x34ae92=document[_0x26d29b(0x1ae)](_0x26d29b(0x1b8))[0x0];_0x34ae92['value']=_0xc2ece6;}function solve_captcha(_0x3ec0f4){return new Promise(_0x23d954=>{var _0x218425=_0x2747,_0x623c35=new Image();_0x623c35[_0x218425(0x1bb)]=_0x3ec0f4,_0x623c35[_0x218425(0x19f)]=()=>{var _0x7a75cf=_0x218425,_0x582d17=_0x623c35['width'],_0x34b93b=_0x623c35[_0x7a75cf(0x198)],_0x24bb55=unsafeWindow[_0x7a75cf(0x1c2)][_0x7a75cf(0x1c5)](_0x7a75cf(0x1b2));_0x24bb55[_0x7a75cf(0x1b7)]=_0x582d17,_0x24bb55['height']=_0x582d17,_0x24bb55['getContext']('2d')[_0x7a75cf(0x1b1)](_0x623c35,0x0,0x0);var _0x38a47c=_0x24bb55[_0x7a75cf(0x1b9)]('2d')['getImageData'](0x0,0x0,_0x582d17,_0x34b93b),_0x2b9ee4=0x3e7,_0x177e51=0x3e7,_0x11d031=0x3e7;for(var _0x3d0613=0x0;_0x3d0613<_0x38a47c[_0x7a75cf(0x1b7)];_0x3d0613++){for(var _0x27d7db=0x0;_0x27d7db<_0x38a47c[_0x7a75cf(0x198)];_0x27d7db++){var _0x1fa306=_0x3d0613*0x4+_0x27d7db*0x4*_0x38a47c[_0x7a75cf(0x1b7)],_0x20dde1=Math[_0x7a75cf(0x191)]((_0x38a47c['data'][_0x1fa306]+_0x38a47c['data'][_0x1fa306+0x1]+_0x38a47c[_0x7a75cf(0x1a4)][_0x1fa306+0x2])/0x3);_0x20dde1<_0x11d031&&(_0x11d031=_0x20dde1,_0x177e51=_0x3d0613,_0x2b9ee4=_0x27d7db);}}_0x23d954({'lowx':_0x177e51,'lowy':_0x2b9ee4});};});}function getRandomDelay(_0x28ed15,_0x2d06c9){var _0x2506f6=_0x2747;return _0x28ed15=Math['ceil'](_0x28ed15),_0x2d06c9=Math[_0x2506f6(0x191)](_0x2d06c9),Math['floor'](Math[_0x2506f6(0x193)]()*(_0x2d06c9-_0x28ed15+0x1))+_0x28ed15;}((async()=>{var _0x21172e=_0x2747;let _0x1744f8=document[_0x21172e(0x1ab)];if(_0x1744f8[_0x21172e(0x1b5)]('objects.phtml')){document['onkeyup']=function(){var _0x5c6397=_0x21172e,_0x49037e=_0x49037e||window['event'];if(_0x49037e[_0x5c6397(0x1bf)]==0x20)return document[_0x5c6397(0x1a8)]('confirm-link')[_0x5c6397(0x199)](),![];else{if(_0x49037e['which']==0x1b)return togglePopup__2020(),![];}};if(removeAreYouSure>0x0){let _0x38fa46=_0x21172e(0x1ac),_0x536509=document[_0x21172e(0x1c5)]('script');_0x536509[_0x21172e(0x1aa)]=_0x38fa46,document[_0x21172e(0x1bd)][_0x21172e(0x1bc)](_0x536509);let _0x14bbd0=document[_0x21172e(0x197)](_0x21172e(0x190));[][_0x21172e(0x1af)][_0x21172e(0x19b)](_0x14bbd0,function(_0x60f53c){var _0x2cdbe3=_0x21172e;_0x60f53c[_0x2cdbe3(0x1c8)](_0x2cdbe3(0x1c3),'oConfirmPurchase(this)');});}}else{if(_0x1744f8[_0x21172e(0x1b5)](_0x21172e(0x1b3))&&doHaggle>0x0){const _0x4dce93=$('html')[_0x21172e(0x1b6)]();waitForKeyElements('div#shopkeeper_makes_deal>p>b',waitForAjax);if(OCR>0x0){const {lowx:_0x28a858,lowy:_0xa262e0}=await solve_captcha(document[_0x21172e(0x1c7)](_0x21172e(0x1ca))[_0x21172e(0x1bb)]);setTimeout(()=>{var _0x3413f6=_0x21172e,_0x11cdb7=document['querySelector'](_0x3413f6(0x1a0)),_0x546a8e=document[_0x3413f6(0x1c5)]('input'),_0x487886=document[_0x3413f6(0x1c5)](_0x3413f6(0x196));_0x546a8e[_0x3413f6(0x19a)]=_0x3413f6(0x1c1),_0x546a8e[_0x3413f6(0x1a1)]='x',_0x546a8e['value']=_0x28a858,_0x11cdb7[_0x3413f6(0x1bc)](_0x546a8e),_0x487886[_0x3413f6(0x19a)]=_0x3413f6(0x1c1),_0x487886[_0x3413f6(0x1a1)]='y',_0x487886[_0x3413f6(0x1b0)]=_0xa262e0,_0x11cdb7['appendChild'](_0x487886),_0x11cdb7[_0x3413f6(0x195)]();},getRandomDelay(minDelay,maxDelay));}}}})());